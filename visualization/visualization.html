<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>CSE6242 Team 141 Project</title>
    
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="../lib/d3-geo-projection.v2.min.js"></script>
    <script type="text/javascript" src="../lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="../lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="../lib/topojson.v2.min.js"></script>
    <link rel="stylesheet" href="visualization.css">

    <title>CSE6242 Team 141 Project</title>

</head>
<body>
    <span class="factor-response">Desert 1:</span> <div class="selector">
        <div class="dropdown-button"><span id="dropdown-label2">Food</span>
        <div class="dropdown-options" id="dropdown2">
            <span onclick="updateDesert('Food')">Food</span>
            <span onclick="updateDesert('Physical activity')">Physical activity</span>
            <span onclick="updateDesert('Public transport')">Public transport</span>
            <span onclick="updateDesert('Education')">Education</span>
            <span onclick="updateDesert('House of worship')">House of worship</span>
        </div>
      </div>
    </div>
    <span class="factor-response">Desert 2:</span> <div class="selector">
        <div class="dropdown-button"><span id="dropdown-label3">Physical activity</span>
        <div class="dropdown-options" id="dropdown3">
            <span onclick="updateDesert2('Food')">Food</span>
            <span onclick="updateDesert2('Physical activity')">Physical activity</span>
            <span onclick="updateDesert2('Public transport')">Public transport</span>
            <span onclick="updateDesert2('Education')">Education</span>
            <span onclick="updateDesert2('House of worship')">House of worship</span>
        </div>
      </div>
    </div>
    <span class="factor-response" style="align-items: center;">Response:</span> <div class="selector">
        <div class="dropdown-button"><span id="dropdown-label1">Cancer</span>
        <div class="dropdown-options" id="dropdown1">
        </div>
      </div>
    </div>
    <br>
    <svg id="deserts"></svg>
    <svg id="choropleth"></svg>
    <script>
        const parameters = ['Arthritis', 'Asthma', 'Binge drinking', 'COPD', 'Cancer', 'Cervical cancer screenings', 'Cholesterol screenings', 'Chronic kidney disease',
                            'Colon cancer screenings', 'Core men\'s health', "Core women's health", 'Coronary heart disease', 'Dental checkups', 'Depression', 'Diabetes',
                            'General poor health', 'Health insurance access', 'High blood pressure', 'High cholesterol', 'Mammograms', 'Medium blood pressure',
                            'No physical activity', 'Obesity', 'Poor mental health', 'Poor physical health', 'Poor sleep', 'Routine checkups', 'Smoking', 'Stroke',
                            'Teeth loss']
        parameters.forEach(element => {
            var a = document.createElement("span");
            a.innerHTML = element;
            a.setAttribute("onClick", "updateResponse(\"" + element + "\")")
            document.getElementById('dropdown1').appendChild(a);
        });
        const parameter_mapping = {"access2": "Health insurance access", "arthritis": "Arthritis", "binge": "Binge drinking",
                                    "bphigh": "High blood pressure", "bpmed": "Medium blood pressure", "cancer": "Cancer",
                                    "casthma": "Asthma", "cervical": "Cervical cancer screenings", "chd": "Coronary heart disease",
                                    "checkup": "Routine checkups", "cholscreen": "Cholesterol screenings", "colon_screen": "Colon cancer screenings",
                                    "copd": "COPD", "corem": "Core men\"s health", "corew": "Core women's health", "csmoking": "Smoking",
                                    "dental": "Dental checkups", "depression": "Depression", "diabetes": "Diabetes", "ghlth": "General poor health",
                                    "highchol": "High cholesterol", "kidney": "Chronic kidney disease", "lpa": "No physical activity", "mammouse": "Mammograms",
                                    "mhlth": "Poor mental health", "obesity": "Obesity", "phlth": "Poor physical health", "sleep": "Poor sleep",
                                    "stroke": "Stroke", "teethlost": "Teeth loss"}
        const parameter_mapping_r = {'Health insurance access': 'access2', 'Arthritis': 'arthritis', 'Binge drinking': 'binge', 'High blood pressure': 'bphigh',
                                    'Medium blood pressure': 'bpmed', 'Cancer': 'cancer', 'Asthma': 'casthma', 'Cervical cancer screenings': 'cervical',
                                    'Coronary heart disease': 'chd', 'Routine checkups': 'checkup', 'Cholesterol screenings': 'cholscreen',
                                    'Colon cancer screenings': 'colon_screen', 'COPD': 'copd', 'Core men"s health': 'corem', "Core women's health": 'corew',
                                    'Smoking': 'csmoking', 'Dental checkups': 'dental', 'Depression': 'depression', 'Diabetes': 'diabetes',
                                    'General poor health': 'ghlth', 'High cholesterol': 'highchol', 'Chronic kidney disease': 'kidney', 'No physical activity': 'lpa',
                                    'Mammograms': 'mammouse', 'Poor mental health': 'mhlth', 'Obesity': 'obesity', 'Poor physical health': 'phlth',
                                    'Poor sleep': 'sleep', 'Stroke': 'stroke', 'Teeth loss': 'teethlost'}
        const factor_mapping_r = {'Food': 'closest_food_nodes_travel_time', 'Physical activity': 'physical_dist', 'Public transport': 'transport_dist',
                                  'Education': 'closest_education_nodes_travel_time', 'Worship': 'closest_worship_nodes_travel_time'}
        
        function updateResponse(resp){
            document.getElementById("dropdown-label1").innerHTML = resp;
            createMap(data);
        }

        function updateDesert(desert){
            document.getElementById("dropdown-label2").innerHTML = desert;
            createMap(data);
        }

        function updateDesert2(desert){
            document.getElementById("dropdown-label3").innerHTML = desert;
            createMap(data);
        }

        // See https://bl.ocks.org/gordlea/27370d1eea8464b04538e6d8ced39e89
        var margin = {top: 20, right: 20, bottom: 70, left: 20}
            , width = window.innerWidth/2 - margin.left - margin.right    // Use the window's width
            , height = window.innerHeight - margin.top - margin.bottom; // Use the window's height
        
        // Set up the SVG
        var svg = d3.select("#choropleth")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        var deserts = d3.select("#deserts")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        var tracts = svg.append("g")
                        .attr("id", "tracts");
        var desert_tracts = deserts.append("g")
                                   .attr("id", "desert_tracts");

        // Prepare the color scales
        var colorScale = d3.scaleSequential(d3.interpolateRdBu);
        var desert_colorScale1 = d3.scaleSequential(d3.interpolatePuBuGn);
        var desert_colorScale2 = d3.scaleSequential(d3.interpolateYlOrRd);

        var legend_g = svg.append("g")
                        .attr("id", "legend")
                        .attr("transform", "translate(" + width/1.3 + ", 0)")
                        .style("font-family", "sans-serif");
        var desert_legend_g = deserts.append("g")
                                .attr("id", "desert_legend")
                                .attr("transform", "translate(" + width/1.3 + ", 0)")
                                .style("font-family", "sans-serif");

        // See https://github.com/Caged/d3-tip
        var tip = d3.tip()
                    .attr('id', 'tooltip')
                    .style("opacity", "50%")
                    .html(function(d){
                        k = parameter_mapping_r[document.getElementById("dropdown-label1").innerHTML].toUpperCase() + "_CrudePrev";
                        m = factor_mapping_r[document.getElementById("dropdown-label2").innerHTML];
                        n = factor_mapping_r[document.getElementById("dropdown-label3").innerHTML];
                        var suffix_1 = ((document.getElementById("dropdown-label2").innerHTML == "Physical activity") || (document.getElementById("dropdown-label2").innerHTML == "Public transport")) ? " distance" : " travel time";
                        var units_1 = (suffix_1 == " distance") ? " km" : " min"
                        var suffix_2 = ((document.getElementById("dropdown-label3").innerHTML == "Physical activity") || (document.getElementById("dropdown-label3").innerHTML == "Public transport")) ? " distance" : " travel time";
                        var units_2 = (suffix_2 == " distance") ? " km" : " min"
                        if (d.properties[k] == null){
                            return "<b>Census tract</b>: " + d.properties["id"] + "<br><b>" + document.getElementById("dropdown-label1").innerHTML + "</b>: <i>Unknown</i><br><b>" + document.getElementById("dropdown-label2").innerHTML + suffix_1 + "</b>: " + d.properties[m].toFixed(2) + units_1 + "<br><b>" + document.getElementById("dropdown-label3").innerHTML + suffix_2 + "</b>: " + d.properties[n].toFixed(2) + units_2;
                        }
                        else{
                            return "<b>Census tract</b>: " + d.properties["id"] + "<br><b>" + document.getElementById("dropdown-label1").innerHTML + "</b>: " + d.properties[k] + "%<br><b>" + document.getElementById("dropdown-label2").innerHTML + suffix_1 + "</b>: " + d.properties[m].toFixed(2) + units_2 + "<br><b>" + document.getElementById("dropdown-label3").innerHTML + suffix_2 + "</b>: " + d.properties[n].toFixed(2) + units_2;
                        }
                        return d.properties[k];
                    });
        
        var desert_tip = d3.tip()
                    .attr('id', 'tooltip')
                    .style("opacity", "50%")
                    .html(function(d){
                        k = parameter_mapping_r[document.getElementById("dropdown-label1").innerHTML].toUpperCase() + "_CrudePrev";
                        m = factor_mapping_r[document.getElementById("dropdown-label2").innerHTML];
                        n = factor_mapping_r[document.getElementById("dropdown-label3").innerHTML];
                        var suffix_1 = ((document.getElementById("dropdown-label2").innerHTML == "Physical activity") || (document.getElementById("dropdown-label2").innerHTML == "Public transport")) ? " distance" : " travel time";
                        var units_1 = (suffix_1 == " distance") ? " km" : " min"
                        var suffix_2 = ((document.getElementById("dropdown-label3").innerHTML == "Physical activity") || (document.getElementById("dropdown-label3").innerHTML == "Public transport")) ? " distance" : " travel time";
                        var units_2 = (suffix_2 == " distance") ? " km" : " min"
                        if (d.properties[k] == null){
                            return "<b>Census tract</b>: " + d.properties["id"] + "<br><b>" + document.getElementById("dropdown-label1").innerHTML + "</b>: <i>Unknown</i><br><b>" + document.getElementById("dropdown-label2").innerHTML + suffix_1 + "</b>: " + d.properties[m].toFixed(2) + units_1 + "<br><b>" + document.getElementById("dropdown-label3").innerHTML + suffix_2 + "</b>: " + d.properties[n].toFixed(2) + units_2;
                        }
                        else{
                            return "<b>Census tract</b>: " + d.properties["id"] + "<br><b>" + document.getElementById("dropdown-label1").innerHTML + "</b>: " + d.properties[k] + "%<br><b>" + document.getElementById("dropdown-label2").innerHTML + suffix_1 + "</b>: " + d.properties[m].toFixed(2) + units_2 + "<br><b>" + document.getElementById("dropdown-label3").innerHTML + suffix_2 + "</b>: " + d.properties[n].toFixed(2) + units_2;
                        }
                        return d.properties[k];
                    });
        
        // Get the projections ready
        var projection = d3.geoAlbersUsa();
        var path = d3.geoPath(projection);
        var data = undefined;

        // Load the data
        d3.json("tracts_data.json").then(function(d){
                projection.fitExtent([[0, 0], [width, height]], d);
                data = d;
                createMap(d);
            }
        );

        function createMap(d){
            // Create the map
            d3.selectAll(".mapPath").remove();
            k = parameter_mapping_r[document.getElementById("dropdown-label1").innerHTML].toUpperCase() + "_CrudePrev";
            colorScale.domain([d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.9), d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.1)]);
            i = 0;
            var legend = d3.legendColor()
                                        .scale(colorScale)
                                        .ascending(true)
                                        .cells(5)
                                        .labels(function (dd){
                                            if (i === 0){
                                                return "> " + dd.generatedLabels[i++] + "%";
                                            }
                                            else if (i === dd.generatedLabels.length-1){
                                                return "< " + dd.generatedLabels[i++] + "%";
                                            }
                                            else{
                                                return dd.generatedLabels[i++] + "%";
                                            }
                                        });
            legend_g.call(legend);
            tracts.call(tip);
            tracts.selectAll("path")
                .data(d.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", "mapPath")
                .attr("census_id", dd => dd.properties['id'])
                .style("fill", function(dd){
                    if (dd.properties[k] == null){
                        return "gray";
                    }
                    else{
                        return colorScale(dd.properties[k]);
                    }
                })
                .on('mousemove', function(dd){
                    // See https://stackoverflow.com/a/56981996
                    tip.style('top', d3.event.pageY - 100 + 'px')
                    .style('left', d3.event.pageX - 100 + 'px');
                })
                .on('mouseover', function(dd, i){
                    tip.show(dd, i);
                    tip.style("background", "rgba(75, 75, 75, 0.8)");
                    d3.select(d3.event.target).style("stroke", "black").style("stroke-width", 3);
                    let census_id = this.getAttribute("census_id");
                    for (let x of document.getElementById("desert_tracts").children){
                        if (x.getAttribute("census_id") == census_id){
                            d3.select(x).style("stroke", "black").style("stroke-width", 3);
                        }
                    }
                })
                .on('mouseout', function(){
                    tip.hide();
                    d3.select(d3.event.target).style("stroke", "none");
                    let census_id = this.getAttribute("census_id");
                    for (let x of document.getElementById("desert_tracts").children){
                        if (x.getAttribute("census_id") == census_id){
                            d3.select(x).style("stroke", "none");
                        }
                    }
                });
            
                // Factor code
                k = factor_mapping_r[document.getElementById("dropdown-label2").innerHTML];
                m = factor_mapping_r[document.getElementById("dropdown-label3").innerHTML];
                desert_colorScale1.domain([d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.1), d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.9)]);
                desert_colorScale2.domain([d3.quantile(d['features'].map(dd => dd.properties[m]).sort((a, b) => a - b), 0.1), d3.quantile(d['features'].map(dd => dd.properties[m]).sort((a, b) => a - b), 0.9)]);
                deserts.call(desert_tip);
                cuts1 = [d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.1), d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.5), d3.quantile(d['features'].map(dd => dd.properties[k]).sort((a, b) => a - b), 0.9)]
                cuts2 = [d3.quantile(d['features'].map(dd => dd.properties[m]).sort((a, b) => a - b), 0.1), d3.quantile(d['features'].map(dd => dd.properties[m]).sort((a, b) => a - b), 0.5), d3.quantile(d['features'].map(dd => dd.properties[m]).sort((a, b) => a - b), 0.9)]
                // Create bivariate colormap
                desert_legend_g.selectAll("text").remove();
                desert_legend_g.selectAll("rect")
                                .data(d3.cross(d3.range(3), d3.range(3)))
                                .enter()
                                .append("rect")
                                .attr("x", dd => 40+22*dd[0])
                                .attr("y", dd => 15+22*dd[1])
                                .attr("width", 23)
                                .attr("height", 23)
                                .attr("fill", dd => d3.interpolate(desert_colorScale1(cuts1[dd[0]]), desert_colorScale2(cuts2[dd[1]]))(0.5));
                desert_legend_g.append("text")
                                .text(document.getElementById("dropdown-label3").innerHTML)
                                .attr("x", -90)
                                .attr("y", 0)
                                .attr("transform", "rotate(-90)")
                                .style("font-size", 12)
                desert_legend_g.append("text")
                                .text(d3.min(d['features'].map(dd => dd.properties[m])).toFixed(2))
                                .attr("x", 8)
                                .attr("y", 85)
                                .style("font-size", 12)
                desert_legend_g.append("text")
                                .text(d3.max(d['features'].map(dd => dd.properties[m])).toFixed(2))
                                .attr("x", 8)
                                .attr("y", 23)
                                .style("font-size", 12)
                desert_legend_g.append("text")
                                .text(document.getElementById("dropdown-label2").innerHTML)
                                .attr("x", 57)
                                .attr("y", 110)
                                .style("font-size", 12)
                desert_legend_g.append("text")
                                .text(d3.min(d['features'].map(dd => dd.properties[k])).toFixed(2))
                                .attr("x", 30)
                                .attr("y", 95)
                                .style("font-size", 12)
                desert_legend_g.append("text")
                                .text(d3.max(d['features'].map(dd => dd.properties[k])).toFixed(2))
                                .attr("x", 90)
                                .attr("y", 95)
                                .style("font-size", 12)

                desert_tracts.selectAll("path")
                       .data(d.features)
                       .enter()
                       .append("path")
                       .attr("d", path)
                       .attr("class", "mapPath")
                       .attr("census_id", dd => dd.properties['id'])
                       .style("fill", function(dd){
                            if (dd.properties[k] == null){
                                return "gray";
                            }
                            else{
                                return d3.interpolate(desert_colorScale1(dd.properties[k]), desert_colorScale2(dd.properties[m]))(0.5);
                            }
                       })
                       .on('mousemove', function(dd){
                            // See https://stackoverflow.com/a/56981996
                            desert_tip.style('top', d3.event.pageY - 100 + 'px')
                            .style('left', d3.event.pageX - 100 + 'px');
                            
                        })
                        .on('mouseover', function(dd, i){
                            desert_tip.show(dd, i);
                            desert_tip.style("background", "rgba(75, 75, 75, 0.8)");
                            d3.select(d3.event.target).style("stroke", "black").style("stroke-width", 3);
                            let census_id = this.getAttribute("census_id");
                            for (let x of document.getElementById("tracts").children){
                                if (x.getAttribute("census_id") == census_id){
                                    d3.select(x).style("stroke", "black").style("stroke-width", 3);
                                }
                            }
                        })
                        .on('mouseout', function(){
                            desert_tip.hide();
                            d3.select(d3.event.target).style("stroke", "none");
                            let census_id = this.getAttribute("census_id");
                            for (let x of document.getElementById("tracts").children){
                                if (x.getAttribute("census_id") == census_id){
                                    d3.select(x).style("stroke", "none");
                                }
                            }
                        });
            }

        var zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on('zoom', function() {
                desert_tracts.attr('transform', d3.event.transform);
                tracts.attr('transform', d3.event.transform);
        });

        svg.call(zoom);
        deserts.call(zoom);
    </script>
</body>
</html>